---
platform: linux

rootfs_uri: docker:///golang:1.25-bookworm

inputs:
- name: repo
- name: spec

outputs:
- name: qa

params:
  AGENT_CLI: claude
  SCORE_THRESHOLD: "7.0"
  GENERATE_TESTS: "true"
  BROWSER_PLAN: "true"
  TARGET_URL: "http://localhost"

run:
  path: sh
  args:
  - -exc
  - |
    echo "=== CI Agent QA ==="

    # Build the QA binary from source.
    cd repo/ci-agent
    go build -o /usr/local/bin/ci-agent-qa ./cmd/ci-agent-qa/
    cd ../..

    # Set up paths.
    export REPO_DIR="$(pwd)/repo"
    export SPEC_FILE="$(pwd)/spec/spec.md"
    export OUTPUT_DIR="$(pwd)/qa"

    echo "Repo: $REPO_DIR"
    echo "Spec: $SPEC_FILE"
    echo "Output: $OUTPUT_DIR"
    echo "Threshold: $SCORE_THRESHOLD"
    echo ""

    ci-agent-qa || true

    echo "=== QA complete ==="
    echo "QA output:"
    cat "$OUTPUT_DIR/qa.json" 2>/dev/null || echo "No QA output"
