---
platform: linux

rootfs_uri: docker:///alpine:3.21

inputs:
- name: fixed-repo
- name: fix-report
- name: review

params:
  GH_TOKEN: ""
  PR_BASE_BRANCH: "main"

run:
  path: sh
  args:
  - -exc
  - |
    echo "=== Create Fix PR ==="

    apk add --no-cache jq git github-cli

    FIX_REPORT="fix-report/fix-report.json"
    if [ ! -f "$FIX_REPORT" ]; then
      echo "No fix report found, skipping PR creation"
      exit 0
    fi

    FIXED=$(jq -r '.summary.fixed' "$FIX_REPORT")
    SKIPPED=$(jq -r '.summary.skipped' "$FIX_REPORT")
    TOTAL=$(jq -r '.summary.total_issues' "$FIX_REPORT")
    REGRESSION_FREE=$(jq -r '.summary.regression_free' "$FIX_REPORT")
    FIX_BRANCH=$(jq -r '.metadata.fix_branch' "$FIX_REPORT")

    echo "Fixed: $FIXED / $TOTAL"
    echo "Skipped: $SKIPPED"
    echo "Regression free: $REGRESSION_FREE"
    echo "Fix branch: $FIX_BRANCH"
    echo ""

    if [ "$FIXED" = "0" ] || [ "$FIXED" = "null" ]; then
      echo "No fixes applied, skipping PR creation"
      exit 0
    fi

    if [ "$REGRESSION_FREE" != "true" ]; then
      echo "Fixes caused regressions and were reverted, skipping PR creation"
      exit 0
    fi

    cd fixed-repo

    # Build PR body.
    PR_TITLE="fix(ci-agent): auto-fix $FIXED issue(s) from agent review"

    FIX_LIST=$(jq -r '.fixes[] | "- **\(.issue_id)** [\(.status)]: committed as \(.commit_sha | .[0:8])"' "../$FIX_REPORT")
    SKIP_LIST=""
    if [ "$SKIPPED" != "0" ]; then
      SKIP_LIST=$(jq -r '.skipped[] | "- **\(.issue_id)** [\(.reason)]: \(.last_error)"' "../$FIX_REPORT")
    fi

    PR_BODY="## Agent Auto-Fix Report

    ### Fixes Applied ($FIXED / $TOTAL issues)
    $FIX_LIST
    "

    if [ -n "$SKIP_LIST" ]; then
      PR_BODY="$PR_BODY
    ### Skipped ($SKIPPED issues)
    $SKIP_LIST
    "
    fi

    PR_BODY="$PR_BODY
    ### Regression Guard
    Status: $([ "$REGRESSION_FREE" = "true" ] && echo "PASS" || echo "FAIL")

    ---
    Generated by ci-agent-fix"

    # Push fix branch and create PR.
    export GH_TOKEN
    git push origin "HEAD:$FIX_BRANCH"
    gh pr create \
      --base "$PR_BASE_BRANCH" \
      --head "$FIX_BRANCH" \
      --title "$PR_TITLE" \
      --body "$PR_BODY"

    echo "=== PR created ==="
