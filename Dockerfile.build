# Multi-stage Dockerfile for building Concourse with embedded frontend assets.
# Produces a self-contained binary with Elm UI, CSS, and JS bundled via
# Go's //go:embed directive â€” no CONCOURSE_WEB_PUBLIC_DIR needed at runtime.
#
# Usage:
#   docker build -f Dockerfile.build -t concourse-local:latest .
#   docker build -f Dockerfile.build --build-arg CONCOURSE_VERSION=8.0.0-jetbridge .

# ---------------------------------------------------------------------------
# Stage 1: Build frontend assets (Elm + LESS + Webpack)
# ---------------------------------------------------------------------------
# NOTE: The elm npm package only ships x86_64 binaries. When building on
# ARM64 (Apple Silicon), use: docker buildx build --platform linux/amd64 ...
FROM node:22-bookworm-slim AS frontend

# Elm's built-in TLS needs system CA certificates to fetch package metadata.
RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates && rm -rf /var/lib/apt/lists/*

WORKDIR /src

# Install yarn via corepack (Yarn 4 is specified in package.json)
RUN corepack enable && corepack prepare yarn@4.12.0 --activate

# Copy dependency manifests first for layer caching
COPY package.json yarn.lock .yarnrc.yml ./
COPY web/elm/elm.json web/elm/elm.json

# Install node dependencies
RUN yarn install --immutable || yarn install

# Copy frontend source
COPY web/ web/
COPY webpack.config.js ./

# Build all frontend assets into web/public/
#   - LESS -> CSS (web/public/main.css)
#   - Elm  -> JS  (web/public/elm.js, web/public/elm.min.js)
#   - Webpack      (web/public/bundle.js)
RUN yarn run build

# ---------------------------------------------------------------------------
# Stage 2: Build Go binary with embedded assets
# ---------------------------------------------------------------------------
FROM golang:1.25-bookworm AS backend

RUN apt-get update && apt-get install -y --no-install-recommends zip && rm -rf /var/lib/apt/lists/*

ARG CONCOURSE_VERSION=0.0.0-dev
ARG TARGETARCH

WORKDIR /src

# Download Go modules first for layer caching
COPY go.mod go.sum ./
RUN go mod download

# Copy full source
COPY . .

# Copy built frontend assets from stage 1 (overwrites any stale files)
COPY --from=frontend /src/web/public/ web/public/

# Build the concourse binary with version injection.
# The //go:embed public directive in web/handler.go embeds web/public/ into
# the binary, so no separate asset directory is needed at runtime.
RUN CGO_ENABLED=0 GOOS=linux GOARCH=${TARGETARCH} \
    go build \
      -ldflags "-s -w -X github.com/concourse/concourse.Version=${CONCOURSE_VERSION}" \
      -o /concourse \
      ./cmd/concourse

# Cross-compile the fly CLI for common platforms. The web server serves
# these archives at /api/v1/cli so users can download fly directly.
RUN mkdir -p /fly-assets && \
    for pair in linux-amd64 linux-arm64 darwin-amd64 darwin-arm64 windows-amd64; do \
      os="${pair%%-*}"; arch="${pair##*-}"; \
      echo "=== Building fly for ${os}/${arch} ==="; \
      ext=""; if [ "$os" = "windows" ]; then ext=".exe"; fi; \
      CGO_ENABLED=0 GOOS="$os" GOARCH="$arch" \
        go build \
          -ldflags "-s -w -X github.com/concourse/concourse.Version=${CONCOURSE_VERSION}" \
          -o "/tmp/fly${ext}" \
          ./fly; \
      if [ "$os" = "windows" ]; then \
        cd /tmp && zip "/fly-assets/fly-${os}-${arch}.zip" "fly${ext}" && rm "fly${ext}" && cd /src; \
      else \
        tar -C /tmp -czf "/fly-assets/fly-${os}-${arch}.tgz" "fly${ext}" && rm "/tmp/fly${ext}"; \
      fi; \
    done

# ---------------------------------------------------------------------------
# Stage 3: Minimal runtime image
# ---------------------------------------------------------------------------
FROM ubuntu:22.04

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      ca-certificates \
      dumb-init \
    && rm -rf /var/lib/apt/lists/*

COPY --from=backend /concourse /usr/local/concourse/bin/concourse
COPY --from=backend /fly-assets/ /usr/local/concourse/fly-assets/

ENV PATH="/usr/local/concourse/bin:${PATH}"

EXPOSE 8080

ENTRYPOINT ["dumb-init", "concourse"]
