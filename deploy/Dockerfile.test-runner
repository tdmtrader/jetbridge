# Build environment for Concourse CI pipeline tasks.
# Contains Go toolchain, kubectl, docker CLI, unzip, and source code at /src.
FROM golang:1.25-bookworm

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    jq \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Install kubectl
RUN curl -fsSL "https://dl.k8s.io/release/$(curl -fsSL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
    -o /usr/local/bin/kubectl && chmod +x /usr/local/bin/kubectl

# Install Docker CLI (for build-image job that mounts Docker socket)
RUN curl -fsSL https://download.docker.com/linux/static/stable/x86_64/docker-27.5.1.tgz \
    | tar xz --strip-components=1 -C /usr/local/bin docker/docker

# Copy source and cache Go modules
WORKDIR /src
COPY go.mod go.sum ./
RUN go mod download
COPY . .
